upstream app_server {
    server app:3000;
}

upstream admin_server {
    server admin:3001;
}

map $http_upgrade $connection_upgrade {
    default upgrade;
    '' close;
}

server {
    listen 80;
    server_name localhost;

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Admin panel - MUST be before /MangyDogCoffee/ to take priority
    location /MangyDogCoffee/admin/ {
        proxy_pass http://admin_server/admin/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }

    # Handle /MangyDogCoffee/admin without trailing slash
    location = /MangyDogCoffee/admin {
        return 302 $scheme://$http_host/MangyDogCoffee/admin/?token=$arg_token;
    }

    # Main app root - redirect to /test
    location = /MangyDogCoffee/ {
        return 302 $scheme://$http_host/MangyDogCoffee/test;
    }

    # Main app
    location /MangyDogCoffee/ {
        proxy_pass http://app_server/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }

    # WebSocket support for real-time features
    location /MangyDogCoffee/ws {
        proxy_pass http://app_server/ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 86400;
    }

    # Root redirect
    location = / {
        return 302 $scheme://$http_host/MangyDogCoffee/;
    }

}

# Admin subdomain server block
server {
    listen 80;
    server_name ~^admin\..*;

    # Rewrite root to /admin so admin container serves correctly
    location = / {
            return 302 /admin?token=your-secure-admin-token-here;
        }

    # Proxy /admin and all sub-paths to admin container
    location /admin {
        proxy_pass http://admin_server;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # App prefix path proxy - strip prefix
    location /MangyDogCoffee/ {
        proxy_pass http://admin_server/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Proxy API endpoints to admin container
    location /api {
        proxy_pass http://admin_server;
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Catch-all for static assets etc
    location / {
        proxy_pass http://admin_server;
        proxy_http_version 1.1;
        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
